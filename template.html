<html>
<head>
	<title>Tune v0.2</title>
</head>
<body style="border-width:0px;">
	<nav style="width:100%; padding:1em;"><h3>Tune</h3></nav>
	<div style="width:100%; height:700px; text-align:center; margin:50px;">
	    <div style="display:inline-block;">
		<div id="player" style="width:640px; height:390px;"></div>
		<br><br>
		Video Url: <input type="text" id="textbox">
		<br><br>
		<input type="submit" value="Submit" onclick="textboxEvent()">
	    </div>
	</div>
	<footer style="width:100%; padding:1em; text-align:center; ">Brandon T. Wood @ 2019</footer>
</body>
<script>
      // https://stackoverflow.com/questions/5957916/how-to-handle-youtube-video-events-started-finished-etc-in-uiwebview-ios
      WS = new WebSocket("ws://" + window.location.hostname + ":3434/ws");
      WS.onmessage = function (e) {onWebsocketEvent(e.data);}
      let VIDEOTIME = 0;
      const TEXTBOX = document.getElementById("textbox");
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      var PLAYER;

      function onYouTubeIframeAPIReady() {
        PLAYER = new YT.Player('player', {
          height: '390',
          width: '640',
          videoId: 'Z_cjiJsVeAs',
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      function onPlayerReady(event) {
        event.target.playVideo();
      }

      function onPlayerStateChange(event) {
	//console.log(" Event Data:" + event.data);
        if (event.data == YT.PlayerState.PLAYING) {
	    websocketEvent("PLAYING", 0);
	    //checkTime();
        } else if (event.data == YT.PlayerState.PAUSED) {
	    websocketEvent("PAUSED", 0);
	    //checkTime();
	}else if (event.data == YT.PlayerState.BUFFERING) {
	    checkTime();
        }
      }

      function onWebsocketEvent(data){
	    console.log("Received from websocket::" + data);
	    var msg = JSON.parse(data);
	    if (msg.Event == "PAUSED"){
		PLAYER.pauseVideo();
	    }else if (msg.Event == "PLAYING"){
		PLAYER.playVideo();
	    }else if (msg.Event == "BUFFER"){
		PLAYER.seekTo(msg.value, true)
	    }else if (msg.Event == "VIDEO"){
		// http://www.youtube.com/v/YsRIMs_-xKM?version=3
		PLAYER.loadVideoByUrl(msg.URL);
	    }
      }

      // When you clikc submit, this takes value from text box to change the video.
      function textboxEvent(){
	    var videoCode=(TEXTBOX.value).split('?')[1].slice(2);
	    let URL = "http://www.youtube.com/v/" + videoCode + "?version=3";
	    console.log(URL);
	    websocketEvent("VIDEO", URL);
	    PLAYER.loadVideoByUrl(URL);
	    TEXTBOX.value = "";
      }

      // https://stackoverflow.com/questions/10175367/youtube-api-event-on-a-specified-time
      function checkTime(){
            var newTime = PLAYER.getCurrentTime();
	    if (VIDEOTIME != newTime){
                 VIDEOTIME=newTime;
  	         console.log("Current video time : " + VIDEOTIME);
	         websocketEvent("BUFFER", VIDEOTIME);
	    }
      }

      function websocketEvent(event, input){
	    // hokey code, we check wether it's a float or a string because Golang 
	    //	    does not have an easy memory safe generic to my understanding.
	    let value = 0;
	    let url = "";
	    if(isNaN(input)){
		  url = input;
	    } else {
		  value = input;
	    }
	    console.log("LOG::" + event + " " + value);
	    var msg = {
    		Event: event,
    		Value: value,
		URL: url,
    		Date: Date.now()
  	    };
	    WS.send(JSON.stringify(msg));
      }

</script>
</html>